---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout 
  title="Saju Calculator - Korean Four Pillars Birth Chart"
  description="Calculate your Korean Four Pillars (Saju) birth chart. Discover personality insights based on this ancient Korean tradition."
>
  <section class="py-24">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-heading font-bold text-dark-50 mb-6">
          Saju <span class="gradient-text">Calculator</span>
        </h1>
        <p class="text-xl text-dark-400 max-w-2xl mx-auto">
          Enter your birth information to generate your personal Four Pillars chart
        </p>
      </div>

      <!-- Calculator Form -->
      <div class="card mb-8" id="calculator-form">
        <form id="saju-form" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Birth Date -->
            <div>
              <label for="birthDate" class="label">Birth Date *</label>
              <input 
                type="date" 
                id="birthDate" 
                name="birthDate" 
                required 
                class="input-field"
              />
            </div>

            <!-- Birth Time -->
            <div>
              <label for="birthTime" class="label">Birth Time (optional)</label>
              <input 
                type="time" 
                id="birthTime" 
                name="birthTime" 
                class="input-field"
              />
              <p class="text-xs text-dark-500 mt-1">Leave blank if unknown (Hour pillar won't be calculated)</p>
            </div>

            <!-- Sex -->
            <div>
              <label for="sex" class="label">Sex (optional)</label>
              <select id="sex" name="sex" class="input-field">
                <option value="">Prefer not to say</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>

            <!-- Timezone -->
            <div>
              <label for="timezone" class="label">Birth Timezone</label>
              <select id="timezone" name="timezone" class="input-field">
                <option value="Asia/Seoul">Asia/Seoul (KST, UTC+9)</option>
                <option value="America/New_York">America/New_York (EST/EDT)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                <option value="Europe/London">Europe/London (GMT/BST)</option>
                <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                <option value="Asia/Tokyo">Asia/Tokyo (JST, UTC+9)</option>
                <option value="Asia/Shanghai">Asia/Shanghai (CST, UTC+8)</option>
                <option value="Asia/Singapore">Asia/Singapore (SGT, UTC+8)</option>
                <option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option>
                <option value="UTC">UTC</option>
              </select>
            </div>
          </div>

          <!-- Consent -->
          <div class="bg-dark-800/50 border border-dark-700 rounded-xl p-4">
            <label class="flex items-start gap-3 cursor-pointer">
              <input 
                type="checkbox" 
                id="consent" 
                name="consent" 
                required
                class="mt-1 w-4 h-4 rounded border-dark-600 bg-dark-800 text-primary-500 focus:ring-primary-500 focus:ring-offset-0"
              />
              <span class="text-sm text-dark-300">
                I understand that this reading is for <strong class="text-dark-100">entertainment and self-reflection only</strong>. 
                I will not use this information to make important life decisions. 
                I have read and agree to the <a href="/disclaimer" class="text-primary-400 hover:underline">Disclaimer</a> and 
                <a href="/privacy-policy" class="text-primary-400 hover:underline">Privacy Policy</a>.
              </span>
            </label>
          </div>

          <button type="submit" class="btn-primary w-full" id="calculate-btn">
            Calculate My Four Pillars
          </button>
        </form>
      </div>

      <!-- Results Section (hidden initially) -->
      <div id="results" class="hidden space-y-8">
        <!-- Pillars Display -->
        <div class="card">
          <h2 class="font-heading text-2xl font-bold text-dark-50 mb-6 text-center">Your Four Pillars</h2>
          
          <div id="pillars-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Pillars will be inserted here -->
          </div>

          <div class="text-center text-sm text-dark-500">
            <p id="birth-info"></p>
          </div>
        </div>

        <!-- Day Master Interpretation -->
        <div class="card">
          <h2 class="font-heading text-2xl font-bold text-dark-50 mb-2" id="day-master-title">Your Day Master</h2>
          <p class="text-dark-400 mb-6" id="day-master-subtitle"></p>
          
          <p class="text-dark-300 mb-6" id="day-master-summary"></p>

          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-heading text-lg font-semibold text-green-400 mb-3">‚ú® Strengths</h3>
              <ul id="strengths-list" class="space-y-2 text-dark-300">
                <!-- Populated by JS -->
              </ul>
            </div>
            <div>
              <h3 class="font-heading text-lg font-semibold text-yellow-400 mb-3">‚ö†Ô∏è Watch-Outs</h3>
              <ul id="watchouts-list" class="space-y-2 text-dark-300">
                <!-- Populated by JS -->
              </ul>
            </div>
          </div>

          <div class="mt-6 p-4 bg-primary-500/10 border border-primary-500/30 rounded-xl">
            <h3 class="font-heading text-lg font-semibold text-primary-400 mb-2">üí° Advice</h3>
            <p id="advice-text" class="text-dark-300"></p>
          </div>
        </div>

        <!-- Element Balance -->
        <div class="card">
          <h2 class="font-heading text-2xl font-bold text-dark-50 mb-6">Element Balance</h2>
          
          <div id="element-bars" class="space-y-3 mb-6">
            <!-- Element bars will be inserted here -->
          </div>

          <p id="element-analysis" class="text-dark-400"></p>
        </div>

        <!-- Learn More Section -->
        <div class="card bg-dark-800/30 border-primary-500/20">
          <h2 class="font-heading text-xl font-bold text-dark-50 mb-4">Want to Learn More?</h2>
          <p class="text-dark-400 mb-4">
            Explore our guides to deepen your understanding of Saju and what your chart means.
          </p>
          <div class="flex flex-wrap gap-3">
            <a href="/guides/what-is-saju-korean-four-pillars" class="btn-secondary text-sm">What is Saju?</a>
            <a href="/guides/day-master-your-core-identity" class="btn-secondary text-sm">Understanding Day Master</a>
            <a href="/guides/understanding-five-elements-wood-fire-earth-metal-water" class="btn-secondary text-sm">Five Elements</a>
          </div>
        </div>

        <!-- Disclaimer -->
        <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl">
          <p class="text-sm text-dark-400">
            <strong class="text-yellow-400">Reminder:</strong> This reading is for entertainment and self-reflection only. 
            It should not be used to make important life decisions. Please see our 
            <a href="/disclaimer" class="text-primary-400 hover:underline">full disclaimer</a>.
          </p>
        </div>

        <!-- Calculate Again -->
        <div class="text-center">
          <button id="reset-btn" class="btn-secondary">
            Calculate Another Chart
          </button>
        </div>
      </div>
    </div>
  </section>

  <script>
    import { calculateFourPillars, getDayMasterInterpretation, getElementAnalysis, ELEMENTS } from '../../lib/saju';
    import type { FourPillars, Pillar } from '../../lib/saju/calendar';

    const form = document.getElementById('saju-form') as HTMLFormElement;
    const formContainer = document.getElementById('calculator-form') as HTMLDivElement;
    const resultsContainer = document.getElementById('results') as HTMLDivElement;
    const resetBtn = document.getElementById('reset-btn') as HTMLButtonElement;

    function createPillarCard(pillar: Pillar | null, index: number): string {
      if (!pillar) {
        return `
          <div class="bg-dark-800/50 border border-dark-700 rounded-xl p-4 text-center opacity-50">
            <p class="text-xs text-dark-500 mb-2">Hour</p>
            <div class="text-4xl mb-2">?</div>
            <p class="text-sm text-dark-500">Unknown</p>
          </div>
        `;
      }

      const colors: Record<string, string> = {
        Wood: 'from-green-500/20 to-green-600/10 border-green-500/30',
        Fire: 'from-red-500/20 to-red-600/10 border-red-500/30',
        Earth: 'from-yellow-500/20 to-yellow-600/10 border-yellow-500/30',
        Metal: 'from-slate-400/20 to-slate-500/10 border-slate-400/30',
        Water: 'from-blue-500/20 to-blue-600/10 border-blue-500/30',
      };

      const colorClass = colors[pillar.stem.element] || 'from-dark-700 to-dark-800 border-dark-600';

      return `
        <div class="bg-gradient-to-b ${colorClass} border rounded-xl p-4 text-center">
          <p class="text-xs text-dark-400 mb-2">${pillar.label}</p>
          <div class="text-3xl mb-1">${pillar.chinese}</div>
          <p class="text-lg font-bold text-dark-100">${pillar.stem.romanized}</p>
          <p class="text-sm text-dark-400">${pillar.branch.animal} ${pillar.branch.animalEmoji}</p>
          <p class="text-xs text-dark-500 mt-2">${pillar.stem.element}</p>
        </div>
      `;
    }

    function createElementBar(element: string, count: number, maxCount: number): string {
      const info = ELEMENTS[element as keyof typeof ELEMENTS];
      const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
      
      return `
        <div class="flex items-center gap-3">
          <span class="w-16 text-sm text-dark-400">${element}</span>
          <div class="flex-1 h-4 bg-dark-800 rounded-full overflow-hidden">
            <div 
              class="h-full rounded-full transition-all duration-500"
              style="width: ${percentage}%; background-color: ${info.color};"
            ></div>
          </div>
          <span class="w-8 text-sm text-dark-400 text-right">${count}</span>
        </div>
      `;
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const birthDate = formData.get('birthDate') as string;
      const birthTime = formData.get('birthTime') as string;
      
      if (!birthDate) return;

      const [year, month, day] = birthDate.split('-').map(Number);
      
      let hour: number | undefined;
      if (birthTime) {
        hour = parseInt(birthTime.split(':')[0], 10);
      }

      // Calculate pillars
      const pillars = calculateFourPillars(year, month, day, hour);
      
      // Get interpretations
      const dayMaster = getDayMasterInterpretation(pillars);
      const elementAnalysis = getElementAnalysis(pillars);

      // Display pillars
      const pillarsContainer = document.getElementById('pillars-container')!;
      pillarsContainer.innerHTML = [
        createPillarCard(pillars.hour, 0),
        createPillarCard(pillars.day, 1),
        createPillarCard(pillars.month, 2),
        createPillarCard(pillars.year, 3),
      ].join('');

      // Birth info
      document.getElementById('birth-info')!.textContent = 
        `Born: ${birthDate}${birthTime ? ' at ' + birthTime : ''}`;

      // Day Master
      document.getElementById('day-master-title')!.textContent = 
        `${dayMaster.title} - ${dayMaster.element} (${dayMaster.polarity})`;
      document.getElementById('day-master-subtitle')!.textContent = 
        `Day Stem: ${pillars.day.stem.korean} (${pillars.day.stem.romanized}) - ${pillars.day.stem.chinese}`;
      document.getElementById('day-master-summary')!.textContent = dayMaster.summary;

      // Strengths
      const strengthsList = document.getElementById('strengths-list')!;
      strengthsList.innerHTML = dayMaster.strengths
        .map(s => `<li class="flex items-start gap-2"><span class="text-green-400">‚Ä¢</span>${s}</li>`)
        .join('');

      // Watch-outs
      const watchoutsList = document.getElementById('watchouts-list')!;
      watchoutsList.innerHTML = dayMaster.watchOuts
        .map(w => `<li class="flex items-start gap-2"><span class="text-yellow-400">‚Ä¢</span>${w}</li>`)
        .join('');

      // Advice
      document.getElementById('advice-text')!.textContent = dayMaster.advice;

      // Element balance
      const maxCount = Math.max(...Object.values(elementAnalysis.balance));
      const elementBars = document.getElementById('element-bars')!;
      elementBars.innerHTML = Object.entries(elementAnalysis.balance)
        .map(([elem, count]) => createElementBar(elem, count, maxCount))
        .join('');

      document.getElementById('element-analysis')!.textContent = elementAnalysis.analysis;

      // Show results
      formContainer.classList.add('hidden');
      resultsContainer.classList.remove('hidden');
      
      // Scroll to top of results
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    });

    resetBtn.addEventListener('click', () => {
      resultsContainer.classList.add('hidden');
      formContainer.classList.remove('hidden');
      form.reset();
      formContainer.scrollIntoView({ behavior: 'smooth' });
    });
  </script>
</BaseLayout>
